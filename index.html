<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FreeTTS â€” Text to Speech</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Fraunces:ital,wght@0,300;0,700;1,300&display=swap" rel="stylesheet" />
  <style>
    /* â”€â”€â”€ CSS Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --bg:        #0d0d0f;
      --surface:   #17171b;
      --border:    #2a2a32;
      --muted:     #4a4a58;
      --text:      #e8e8f0;
      --sub:       #9090a8;
      --accent:    #e8c547;
      --accent2:   #5ee7a4;
      --danger:    #e85d75;
      --radius:    12px;
      --font-mono: 'DM Mono', monospace;
      --font-disp: 'Fraunces', serif;
    }
    [data-theme="light"] {
      --bg:      #f4f3ee;
      --surface: #ffffff;
      --border:  #ddddd4;
      --muted:   #b0b0a8;
      --text:    #1a1a20;
      --sub:     #666660;
    }

    /* â”€â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 16px; }
    body {
      font-family: var(--font-mono);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem 4rem;
      transition: background .3s, color .3s;
    }

    /* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      width: 100%;
      max-width: 780px;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 2.5rem;
    }
    .logo {
      font-family: var(--font-disp);
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: -1px;
      color: var(--text);
    }
    .logo span { color: var(--accent); }
    .tagline {
      font-size: .7rem;
      color: var(--sub);
      letter-spacing: .12em;
      text-transform: uppercase;
      align-self: center;
    }
    #theme-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 50px;
      padding: .35rem .9rem;
      cursor: pointer;
      font-family: var(--font-mono);
      font-size: .75rem;
      transition: background .2s, border-color .2s;
    }
    #theme-btn:hover { border-color: var(--accent); }

    /* â”€â”€â”€ Main Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 2rem;
      width: 100%;
      max-width: 780px;
      display: flex;
      flex-direction: column;
      gap: 1.4rem;
    }

    /* â”€â”€â”€ Textarea â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .text-wrap { position: relative; }
    #text-input {
      width: 100%;
      min-height: 200px;
      resize: vertical;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: var(--font-mono);
      font-size: .9rem;
      line-height: 1.8;
      padding: 1rem 1rem 2rem;
      outline: none;
      transition: border-color .2s;
    }
    #text-input:focus { border-color: var(--accent); }
    #char-count {
      position: absolute;
      bottom: .6rem; right: .8rem;
      font-size: .7rem;
      color: var(--muted);
      pointer-events: none;
    }

    /* â”€â”€â”€ Highlighted output â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #highlight-box {
      display: none;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      font-size: .9rem;
      line-height: 1.8;
      min-height: 100px;
      max-height: 260px;
      overflow-y: auto;
      word-break: break-word;
    }
    #highlight-box .word { transition: background .15s; border-radius: 3px; padding: 0 2px; }
    #highlight-box .word.active {
      background: var(--accent);
      color: #000;
    }

    /* â”€â”€â”€ Controls Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: .8rem;
    }
    label.field {
      display: flex;
      flex-direction: column;
      gap: .4rem;
      font-size: .72rem;
      color: var(--sub);
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    select {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: var(--font-mono);
      font-size: .85rem;
      padding: .55rem .8rem;
      outline: none;
      cursor: pointer;
      transition: border-color .2s;
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239090a8' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right .8rem center;
      padding-right: 2rem;
    }
    select:focus { border-color: var(--accent); }

    /* â”€â”€â”€ Sliders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sliders {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: .8rem;
    }
    .slider-field {
      display: flex;
      flex-direction: column;
      gap: .4rem;
      font-size: .72rem;
      color: var(--sub);
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .slider-field .val {
      color: var(--accent);
      font-size: .8rem;
    }
    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      outline: none;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px; height: 16px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }

    /* â”€â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-row {
      display: flex;
      gap: .7rem;
      flex-wrap: wrap;
    }
    button.btn {
      font-family: var(--font-mono);
      font-size: .82rem;
      border: none;
      border-radius: 8px;
      padding: .65rem 1.4rem;
      cursor: pointer;
      transition: transform .12s, opacity .2s, background .2s;
      display: flex;
      align-items: center;
      gap: .5rem;
      letter-spacing: .04em;
    }
    button.btn:active { transform: scale(.96); }
    button.btn:disabled { opacity: .35; cursor: not-allowed; }

    .btn-play  { background: var(--accent);  color: #000; font-weight: 500; }
    .btn-pause { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
    .btn-stop  { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
    .btn-dl    { background: var(--accent2); color: #000; font-weight: 500; margin-left: auto; }

    .btn-pause:hover, .btn-stop:hover { border-color: var(--accent); }
    .btn-play:hover  { opacity: .88; }
    .btn-dl:hover    { opacity: .88; }

    /* â”€â”€â”€ Progress Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .progress-wrap {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }
    #progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 2px;
      transition: width .3s linear;
    }

    /* â”€â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #status {
      font-size: .75rem;
      color: var(--sub);
      min-height: 1rem;
    }
    #status.playing { color: var(--accent2); }
    #status.error   { color: var(--danger); }

    /* â”€â”€â”€ Download note â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dl-note {
      font-size: .72rem;
      color: var(--muted);
      line-height: 1.6;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: .8rem 1rem;
    }
    .dl-note strong { color: var(--sub); }

    /* â”€â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer {
      margin-top: 2.5rem;
      font-size: .7rem;
      color: var(--muted);
      text-align: center;
    }

    /* â”€â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 540px) {
      .controls { grid-template-columns: 1fr; }
      .sliders  { grid-template-columns: 1fr 1fr; }
      .btn-dl   { margin-left: 0; }
      .logo     { font-size: 1.5rem; }
    }
  </style>
</head>
<body>

  <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header>
    <div>
      <div class="logo">Free<span>TTS</span></div>
      <div class="tagline">Browser TTS Â· No backend Â· 100% free</div>
    </div>
    <button id="theme-btn" onclick="toggleTheme()">â˜€ Light</button>
  </header>

  <!-- â”€â”€ Main Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="card">

    <!-- Text input -->
    <div class="text-wrap">
      <textarea id="text-input" placeholder="Paste or type your text hereâ€¦" oninput="onTextInput()"></textarea>
      <span id="char-count">0 chars</span>
    </div>

    <!-- Highlighted reading view (shown while speaking) -->
    <div id="highlight-box" aria-live="polite"></div>

    <!-- Voice / Language selects -->
    <div class="controls">
      <label class="field">
        Language
        <select id="lang-select" onchange="filterVoices()"></select>
      </label>
      <label class="field">
        Voice
        <select id="voice-select"></select>
      </label>
    </div>

    <!-- Rate / Pitch / Volume -->
    <div class="sliders">
      <div class="slider-field">
        Speed <span class="val" id="rate-val">1.0Ã—</span>
        <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1"
               oninput="document.getElementById('rate-val').textContent = (+this.value).toFixed(1)+'Ã—'" />
      </div>
      <div class="slider-field">
        Pitch <span class="val" id="pitch-val">1.0</span>
        <input type="range" id="pitch" min="0" max="2" step="0.1" value="1"
               oninput="document.getElementById('pitch-val').textContent = (+this.value).toFixed(1)" />
      </div>
      <div class="slider-field">
        Volume <span class="val" id="vol-val">100%</span>
        <input type="range" id="volume" min="0" max="1" step="0.05" value="1"
               oninput="document.getElementById('vol-val').textContent = Math.round(+this.value*100)+'%'" />
      </div>
    </div>

    <!-- Progress -->
    <div class="progress-wrap"><div id="progress-bar"></div></div>

    <!-- Status -->
    <div id="status">Ready â€” enter text and press Play.</div>

    <!-- Action buttons -->
    <div class="btn-row">
      <button class="btn btn-play"  id="btn-play"  onclick="playSpeech()">â–¶ Play</button>
      <button class="btn btn-pause" id="btn-pause" onclick="pauseSpeech()" disabled>â¸ Pause</button>
      <button class="btn btn-stop"  id="btn-stop"  onclick="stopSpeech()"  disabled>â–  Stop</button>
      <button class="btn btn-dl"    id="btn-dl"    onclick="downloadAudio()">â†“ Download WAV</button>
    </div>

    <!-- Download note -->
    <div class="dl-note">
      <strong>About Download:</strong> Uses the Web Audio API to record your browser's speech synthesis output in real-time and saves it as a WAV file. The text will be read aloud while recording â€” make sure your system audio is not muted. Download quality depends on your browser and OS voice engine.
    </div>

  </div>

  <footer>FreeTTS Â· Pure client-side Â· Works offline after first load Â· <a href="#" style="color:var(--sub)">Host on GitHub Pages / Netlify / Vercel</a></footer>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       JavaScript â€” TTS Engine
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script>
  /* â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let voices       = [];      // all available voices
  let words        = [];      // tokenised words for highlighting
  let wordIndex    = 0;       // current word being spoken
  let totalWords   = 0;
  let isPaused     = false;
  let isPlaying    = false;
  let utterances   = [];      // queue of SpeechSynthesisUtterance

  /* â”€â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function toggleTheme() {
    const html = document.documentElement;
    const isDark = html.dataset.theme === 'dark';
    html.dataset.theme = isDark ? 'light' : 'dark';
    document.getElementById('theme-btn').textContent = isDark ? 'ğŸŒ™ Dark' : 'â˜€ Light';
  }

  /* â”€â”€â”€ Voice loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function loadVoices() {
    voices = window.speechSynthesis.getVoices();
    if (!voices.length) return;          // not ready yet

    // Build language list
    const langs = [...new Set(voices.map(v => v.lang))].sort();
    const langSel = document.getElementById('lang-select');
    langSel.innerHTML = '<option value="">All languages</option>' +
      langs.map(l => `<option value="${l}">${l}</option>`).join('');

    filterVoices();
  }

  function filterVoices() {
    const lang  = document.getElementById('lang-select').value;
    const sel   = document.getElementById('voice-select');
    const filtered = lang ? voices.filter(v => v.lang === lang) : voices;

    sel.innerHTML = filtered.map((v, i) =>
      `<option value="${i}_${v.name}">${v.name} (${v.lang})${v.localService ? '' : ' â˜'}</option>`
    ).join('');
  }

  // Voices load asynchronously in some browsers
  window.speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();

  /* â”€â”€â”€ Text input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function onTextInput() {
    const txt = document.getElementById('text-input').value;
    document.getElementById('char-count').textContent = txt.length.toLocaleString() + ' chars';
  }

  /* â”€â”€â”€ Get selected voice object â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function getSelectedVoice() {
    const sel  = document.getElementById('voice-select');
    const name = sel.value.replace(/^\d+_/, '');
    return voices.find(v => v.name === name) || null;
  }

  /* â”€â”€â”€ Build word tokens for highlighting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function tokenise(text) {
    // Split on whitespace, preserving spaces as tokens so we can rejoin
    return text.match(/\S+|\s+/g) || [];
  }

  function buildHighlightBox(tokens) {
    const box = document.getElementById('highlight-box');
    box.innerHTML = tokens.map((t, i) =>
      /\S/.test(t)
        ? `<span class="word" id="w${i}">${t.replace(/</g, '&lt;')}</span>`
        : t.replace(/\n/g, '<br>')
    ).join('');
    box.style.display = 'block';
  }

  function highlightWord(idx) {
    // Remove previous active
    document.querySelectorAll('.word.active').forEach(el => el.classList.remove('active'));
    const el = document.getElementById('w' + idx);
    if (el) {
      el.classList.add('active');
      el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }
  }

  /* â”€â”€â”€ Play â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function playSpeech() {
    const text = document.getElementById('text-input').value.trim();
    if (!text) { setStatus('Please enter some text first.', 'error'); return; }

    if (isPaused) {
      window.speechSynthesis.resume();
      isPaused = false;
      setStatus('â–¶ Playingâ€¦', 'playing');
      setBtns(true);
      return;
    }

    stopSpeech();   // clear any previous

    const voice  = getSelectedVoice();
    const rate   = parseFloat(document.getElementById('rate').value);
    const pitch  = parseFloat(document.getElementById('pitch').value);
    const volume = parseFloat(document.getElementById('volume').value);

    // Tokenise for highlighting
    const tokens = tokenise(text);
    words = tokens;
    totalWords = tokens.filter(t => /\S/.test(t)).length;
    wordIndex = 0;
    buildHighlightBox(tokens);
    document.getElementById('text-input').style.display = 'none';

    // Chrome has ~32KB utterance limit â€” chunk by sentence / paragraph
    const chunks = chunkText(text, 200);  // max ~200 words per chunk

    let wordsSoFar = 0;

    chunks.forEach((chunk, ci) => {
      const utt = new SpeechSynthesisUtterance(chunk);
      if (voice)  utt.voice  = voice;
      utt.rate   = rate;
      utt.pitch  = pitch;
      utt.volume = volume;

      // Word boundary events for highlighting
      utt.onboundary = (e) => {
        if (e.name !== 'word') return;
        // Count words spoken so far and highlight in the box
        const spokenWords = chunk.slice(0, e.charIndex).split(/\s+/).filter(Boolean).length;
        const globalWord  = wordsSoFar + spokenWords;
        // Map globalWord to token index
        let wCount = 0;
        for (let i = 0; i < tokens.length; i++) {
          if (/\S/.test(tokens[i])) {
            if (wCount === globalWord) { highlightWord(i); break; }
            wCount++;
          }
        }
        // Update progress
        const pct = Math.min(100, Math.round((globalWord / totalWords) * 100));
        document.getElementById('progress-bar').style.width = pct + '%';
      };

      utt.onstart = () => {
        if (ci === 0) { isPlaying = true; setBtns(true); setStatus('â–¶ Playingâ€¦', 'playing'); }
      };

      utt.onend = () => {
        wordsSoFar += chunk.split(/\s+/).filter(Boolean).length;
        if (ci === chunks.length - 1) {
          onSpeechEnd();
        }
      };

      utt.onerror = (e) => {
        if (e.error !== 'interrupted') setStatus('Error: ' + e.error, 'error');
        onSpeechEnd();
      };

      utterances.push(utt);
    });

    utterances.forEach(u => window.speechSynthesis.speak(u));
  }

  function onSpeechEnd() {
    isPlaying = false;
    isPaused  = false;
    document.getElementById('progress-bar').style.width = '100%';
    setStatus('âœ“ Done.', '');
    setBtns(false);
    // Restore textarea
    document.getElementById('text-input').style.display = '';
    document.getElementById('highlight-box').style.display = 'none';
    setTimeout(() => document.getElementById('progress-bar').style.width = '0%', 1500);
  }

  /* â”€â”€â”€ Pause â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function pauseSpeech() {
    if (!isPlaying) return;
    if (isPaused) {
      window.speechSynthesis.resume();
      isPaused = false;
      document.getElementById('btn-pause').textContent = 'â¸ Pause';
      setStatus('â–¶ Playingâ€¦', 'playing');
    } else {
      window.speechSynthesis.pause();
      isPaused = true;
      document.getElementById('btn-pause').textContent = 'â–¶ Resume';
      setStatus('â¸ Paused', '');
    }
  }

  /* â”€â”€â”€ Stop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function stopSpeech() {
    window.speechSynthesis.cancel();
    utterances = [];
    isPlaying  = false;
    isPaused   = false;
    setStatus('â–  Stopped.', '');
    setBtns(false);
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('text-input').style.display = '';
    document.getElementById('highlight-box').style.display = 'none';
    document.querySelectorAll('.word.active').forEach(el => el.classList.remove('active'));
  }

  /* â”€â”€â”€ Chunk long text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function chunkText(text, maxWords) {
    const sentences = text.match(/[^.!?\n]+[.!?\n]?/g) || [text];
    const chunks = [];
    let current  = '';
    let wCount   = 0;

    for (const sent of sentences) {
      const sw = sent.trim().split(/\s+/).length;
      if (wCount + sw > maxWords && current) {
        chunks.push(current.trim());
        current = sent;
        wCount  = sw;
      } else {
        current += ' ' + sent;
        wCount  += sw;
      }
    }
    if (current.trim()) chunks.push(current.trim());
    return chunks.filter(Boolean);
  }

  /* â”€â”€â”€ Download WAV (real-time AudioContext recording) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function downloadAudio() {
    const text = document.getElementById('text-input').value.trim();
    if (!text) { setStatus('No text to record.', 'error'); return; }
    if (isPlaying) { setStatus('Stop current playback first.', 'error'); return; }

    setStatus('âº Recording speechâ€¦ please waitâ€¦', 'playing');
    document.getElementById('btn-dl').disabled = true;

    try {
      // We use AudioContext + getUserMedia to capture system/tab audio.
      // More reliable cross-browser: we synthesize, capture via StreamDestination.
      // However, speechSynthesis output can't be captured directly in all browsers.
      // Best-effort: we use an offline render approach with Web Speech + MediaRecorder
      // on a Web Audio stream. For full capture we use getDisplayMedia (tab capture).

      // ---- Approach: speak into a silent AudioContext, capture via MediaRecorder ----
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const dest     = audioCtx.createMediaStreamDestination();

      // We also need to play it audibly (required for speech synthesis to work)
      const gainNode = audioCtx.createGain();
      gainNode.connect(dest);
      gainNode.connect(audioCtx.destination);

      const recorder = new MediaRecorder(dest.stream, { mimeType: getSupportedMime() });
      const chunks   = [];
      recorder.ondataavailable = e => { if (e.data.size) chunks.push(e.data); };

      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: recorder.mimeType });
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href     = url;
        a.download = 'FreeTTS-speech.' + (recorder.mimeType.includes('ogg') ? 'ogg' : 'wav');
        a.click();
        URL.revokeObjectURL(url);
        setStatus('âœ“ Downloaded!', '');
        document.getElementById('btn-dl').disabled = false;
        audioCtx.close();
      };

      recorder.start();

      // Speak using speechSynthesis
      const voice  = getSelectedVoice();
      const rate   = parseFloat(document.getElementById('rate').value);
      const pitch  = parseFloat(document.getElementById('pitch').value);
      const textChunks = chunkText(text, 200);
      let done = 0;

      const speakChunk = (i) => {
        if (i >= textChunks.length) { recorder.stop(); return; }
        const utt = new SpeechSynthesisUtterance(textChunks[i]);
        if (voice) utt.voice = voice;
        utt.rate  = rate;
        utt.pitch = pitch;
        utt.volume = 1;
        utt.onend = () => speakChunk(i + 1);
        utt.onerror = () => { recorder.stop(); setStatus('Recording error.', 'error'); document.getElementById('btn-dl').disabled = false; };
        window.speechSynthesis.speak(utt);
      };

      speakChunk(0);

    } catch (err) {
      setStatus('Download failed: ' + err.message, 'error');
      document.getElementById('btn-dl').disabled = false;
    }
  }

  function getSupportedMime() {
    const types = ['audio/webm;codecs=opus', 'audio/ogg;codecs=opus', 'audio/webm', 'audio/ogg'];
    return types.find(t => MediaRecorder.isTypeSupported(t)) || '';
  }

  /* â”€â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function setStatus(msg, cls) {
    const el = document.getElementById('status');
    el.textContent = msg;
    el.className   = cls || '';
  }

  function setBtns(playing) {
    document.getElementById('btn-pause').disabled = !playing;
    document.getElementById('btn-stop').disabled  = !playing;
    document.getElementById('btn-play').textContent = playing ? 'â–¶ Playing' : 'â–¶ Play';
  }
  </script>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DEPLOYMENT NOTES (leave as HTML comment for reference)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  â”€â”€ GitHub Pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. Create a new repo, e.g. "voiceforge"
  2. Drop this index.html into the root
  3. Push to main branch
  4. Settings â†’ Pages â†’ Source: main / (root)
  5. Visit: https://<username>.github.io/voiceforge/

  â”€â”€ Netlify â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. Go to netlify.com â†’ "Add new site" â†’ "Deploy manually"
  2. Drag & drop the folder containing this file
  3. Done â€” instant CDN URL!

  â”€â”€ Vercel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. Install Vercel CLI: npm i -g vercel
  2. cd into the folder containing index.html
  3. Run: vercel --yes
  4. Done!

  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

</body>
</html>
